<!doctype html>

<title>Image 2.0</title>

<style>
body {
	background-color: #14151b;
	color: #072c66;
	font-family: 'Helvetica';
	text-align: center;
}

.canvas {
    margin: auto;
    max-height: 1024px;
    max-width: 1024px;
}

div.container {
	font-weight: 800;
}

.header {
	font-size: 40px;
	font-weight: 1000;
}

.setting {
	font-weight: 400;
}
</style>

<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/cropper/2.3.4/cropper.min.css'>
<script src='https://cdnjs.cloudflare.com/ajax/libs/cropperjs/0.8.1/cropper.min.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css'>

<h1 class='header'>Image 2.0</h1>

<form method='post' action='/' enctype='multipart/form-data' id='form'>
    <input class='setting' type='file' name='file' style="margin-left: 110px" accept='image/*' required>

    <p>
    <div class='canvas'></div>
    </p>

    <p>
        <label class='setting'>Enhancement level:</label>
        <select name='enhancement_level'>
            <option value=1>1 (Very low)</option>
            <option value=2>2</option>
            <option value=3 selected='selected'>3</option>
            <option value=4>4</option>
            <option value=5>5 (Very high)</option>
        </select>
    </p>

    <p>
        <label>
            <input type='checkbox' checked='checked' name='enlarge'>
            <span class='setting'>Enlarge</span>
        </label>
    </p>
</form>

<p>
    <input type='button' value='Upgrade' id='upgrade'>
</p>
<br>

<script>
    let file = document.getElementsByName('file')[0],
    canvas = document.getElementsByClassName('canvas')[0],
    upgrade = document.getElementById('upgrade');

    function create_cropper(evt){
        const allowed = ['jpeg', 'jpg', 'png', 'gif'], name = file.files[0].name;
        const extension = name.split('.').pop();
        if (!allowed.includes(extension)){
            alert('File has to be .jpeg, .jpg, .png, or .gif');
            file.value = '';
            return;
        };

        const reader = new FileReader();
        reader.onload = create_cropper => {
            let img = document.createElement('img');
            img.id = 'image';
            img.src = create_cropper.target.result;
            canvas.innerHTML = '';
            canvas.appendChild(img);
            cropper = new Cropper(img, {
                autoCropArea: 1,
                viewMode: 1,
            });
        };
        reader.readAsDataURL(evt.target.files[0]);
    };
    file.addEventListener('change', create_cropper);


    function crop(){
        const crop_box = cropper.cropBox;
        const w = crop_box.clientWidth, h = crop_box.clientHeight;
        const mx = Math.max(w, h);

        if (800 < mx){
            alert('The cropped area is too large, please shrink it');
            return false;
        };

        cropper.getCroppedCanvas().toBlob((blob) => {
            const name = file.files[0].name;
            cropped = new File([blob], name);

            let container = new DataTransfer();
            container.items.add(cropped);
            file.files = container.files;
        });
        return true;
    };

    function submit(){
        document.getElementById('form').submit();
    };

    function crop_submit(){
        const f = crop();
        if (f){
            setTimeout(submit, 200);
        };
    };
    upgrade.addEventListener('click', crop_submit);
</script>


<div class='container'>
    {% if img %}
        <p>Original</p>
        <img src='data:image/jpeg;base64,{{ img }}'>
    {% endif %}
</div>

<br>

<div class='container'>
    {% if res %}
        <p>Upgraded</p>
        <img src='data:image/jpeg;base64,{{ res }}'>
    {% endif %}
</div>